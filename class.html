<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Classe 1A - SchoolLedger</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Classe <span id="classTitle">1A</span></h1>
        <p>Elenco studenti — doppio clic su riga per aprire pagina studente</p>
      </div>
      <div style="margin-left:auto" class="small"><a href="index.html">← Torna home</a></div>
    </div>

    <div class="card">
      <div class="controls">
        <button class="btn" id="addCol">+ Nuova colonna</button>
        <button class="btn secondary" id="bulkBtn">Bulk add (stesso importo)</button>
        <input id="filter" class="input" placeholder="Cerca per nome o ID">
        <button class="btn ghost" id="newStudent">+ Nuovo studente</button>
      </div>

      <div class="table-wrap">
        <table id="classTable">
          <thead>
            <tr>
              <th class="sticky">ID</th>
              <th class="sticky">Nome</th>
              <th class="sticky right">Saldo</th>
              <!-- colonne transazioni dinamiche -->
            </tr>
          </thead>
          <tbody id="classBody"></tbody>
        </table>
      </div>

      <div id="status" class="status"></div>
      <div class="student-panel small">
        <strong>Nota:</strong> doppio clic su una riga per aprire la pagina studente. Puoi modificare le celle direttamente; i dati sono salvati localmente.
      </div>
    </div>
  </div>

<script src="script.js"></script>
<script>
  // class page logic (API version)
const params = new URLSearchParams(window.location.search);
const classId = params.get('c') || '1A';
document.getElementById('classTitle').textContent = classId;

async function renderClass(){
  const res = await apiGet({ action: 'class', class: classId });
  if (!res.success) { showStatusClass('Errore: ' + (res.error||'API'), 'err'); return; }

  const students = res.students; // [{id,name,balance}, ...]
  const tableHead = document.querySelector('#classTable thead tr');
  // reset a 3 colonne fisse (ID, Nome, Saldo)
  while (tableHead.cells.length > 3) tableHead.deleteCell(3);

  const tbody = document.getElementById('classBody');
  tbody.innerHTML = '';

  students.forEach(s => {
    const tr = document.createElement('tr');

    const tdId = document.createElement('td');
    tdId.className = 'sticky';
    tdId.textContent = s.id;
    tr.appendChild(tdId);

    const tdName = document.createElement('td');
    tdName.className = 'sticky';
    const a = document.createElement('a');
    a.href = 'student.html?id=' + encodeURIComponent(s.id) + '&c=' + encodeURIComponent(classId);
    a.textContent = s.name;
    tdName.appendChild(a);
    tr.appendChild(tdName);

    const tdBal = document.createElement('td');
    tdBal.className = 'right sticky';
    tdBal.textContent = '€' + (Number(s.balance||0)).toFixed(2);
    tr.appendChild(tdBal);

    tbody.appendChild(tr);
  });
}
renderClass();

// Bulk add (collettivo)
document.getElementById('bulkBtn').addEventListener('click', async ()=>{
  const res = await apiGet({ action:'class', class: classId });
  if(!res.success) return alert('Errore caricando classe');
  const amount = parseFloat(prompt('Importo per tutti (+/-):', '1.00'));
  if (isNaN(amount)) return;
  const note = prompt('Motivazione (facoltativa):', '');
  const ids = res.students.map(s => s.id);
  const r2 = await apiPost({ action:'bulk', class: classId, ids, amount, note });
  if(!r2.success) return alert('Errore bulk: ' + (r2.error||''));
  alert('Aggiunti ' + r2.added + ' movimenti');
  renderClass(); // ricarica bilanci
});

// (opzionale) Nuovo studente: qui servirebbe una API "add student"; per ora gestisci Students manualmente nel foglio
document.getElementById('newStudent').addEventListener('click', ()=>{
  alert('Per ora aggiungi gli studenti nella scheda "Students" del Google Sheet.');
});

function showStatusClass(m,t){
  const el = document.getElementById('status');
  el.textContent = m; el.classList.add('show');
  el.style.background = t==='err' ? '#ffdede' : '#e8ffe8';
  setTimeout(()=> el.classList.remove('show'), 2200);
}

</script>
</body>
</html>

