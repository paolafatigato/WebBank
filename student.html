<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studente - SchoolLedger</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="stuName">Studente</h1>
        <p id="stuSubtitle">ID: ...</p>
      </div>
      <div style="margin-left:auto" class="small"><a href="index.html">Home</a> • <a id="backClass" href="#">Torna classe</a></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Saldo corrente</div>
          <div style="font-size:22px;font-weight:600" id="stuBalance">€0.00</div>
        </div>
        <div style="text-align:right">
          <div class="small">Aggiungi transazione</div>
          <input id="amount" type="number" step="0.01" class="input" placeholder="+5 or -3">
          <input id="note" class="input" placeholder="Motivazione">
          <div style="margin-top:8px">
            <button class="btn" id="addTrans">Aggiungi</button>
          </div>
        </div>
      </div>

      <hr>

      <div>
        <strong>Transazioni</strong>
        <div id="transList" style="margin-top:8px"></div>
      </div>

      <div class="student-panel small" style="margin-top:12px">
        <div>Per aprire questa pagina con NFC, scrivi nel tag l'URL: <code>.../student.html?id=IL_TUO_ID</code></div>
      </div>
    </div>
  </div>

<script src="script.js"></script>
<script>
  // student page logic (API version)
const params = new URLSearchParams(window.location.search);
const id = params.get('id');
const classParam = params.get('c') || '';

async function loadStudent() {
  // chiama API per prendere dati studente
  const res = await apiGet({ action:'student', id, class: classParam });
  if (!res.success) {
    alert('Studente non trovato nel foglio Google.');
    location.href='index.html';
    return;
  }

  const st = res.student;
  document.getElementById('stuName').textContent = st.name;
  document.getElementById('stuSubtitle').textContent = `ID: ${st.id} • Classe: ${st.class}`;
  document.getElementById('stuBalance').textContent = '€' + Number(st.balance).toFixed(2);

  // lista transazioni
  const list = document.getElementById('transList');
  list.innerHTML = '';
  (st.transactions||[]).forEach(t => {
    const row = document.createElement('div');
    row.className = 'log-entry';
    const left = document.createElement('div'); 
    left.textContent = t.timestamp ? new Date(t.timestamp).toLocaleString() : '';
    const right = document.createElement('div'); 
    right.textContent = (t.amount>0?'+':'') + t.amount + (t.note?` — ${t.note}`:'');
    right.style.fontWeight = '600';
    row.appendChild(left); 
    row.appendChild(right);
    list.appendChild(row);
  });

  // bottone aggiungi transazione
  document.getElementById('addTrans').onclick = async () => {
    const a = parseFloat(document.getElementById('amount').value);
    const note = document.getElementById('note').value || '';
    if (isNaN(a)) return alert('Inserisci importo valido');
    const r = await apiPost({ action:'transaction', class: st.class, id: st.id, amount: a, note });
    if (!r.success) return alert('Errore salvataggio');
    document.getElementById('amount').value = ''; 
    document.getElementById('note').value = '';
    loadStudent(); // ricarica
  };
}

loadStudent();

</script>
</body>
</html>

