<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studente - SchoolLedger</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="stuName">Studente</h1>
        <p id="stuSubtitle">ID: ...</p>
      </div>
      <div style="margin-left:auto" class="small"><a href="index.html">Home</a> • <a id="backClass" href="#">Torna classe</a></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Saldo corrente</div>
          <div style="font-size:22px;font-weight:600" id="stuBalance">€0.00</div>
        </div>
        <div style="text-align:right">
          <div class="small">Aggiungi transazione</div>
          <input id="amount" type="number" step="0.01" class="input" placeholder="+5 or -3">
          <input id="note" class="input" placeholder="Motivazione">
          <div style="margin-top:8px">
            <button class="btn" id="addTrans">Aggiungi</button>
          </div>
        </div>
      </div>

      <hr>

      <div>
        <strong>Transazioni</strong>
        <div id="transList" style="margin-top:8px"></div>
      </div>

      <div class="student-panel small" style="margin-top:12px">
        <div>Per aprire questa pagina con NFC, scrivi nel tag l'URL: <code>.../student.html?id=IL_TUO_ID</code></div>
      </div>
    </div>
  </div>

<script src="script.js"></script>
<script>
  // open student by id param
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const classParam = params.get('c') || null;

  if(!id) {
    alert('Nessun id fornito'); location.href='index.html';
  } else {
    const db = loadDB();
    // try find in provided class first, else search all classes
    let student = null;
    let foundClass = null;
    if(classParam && db.classes[classParam]) {
      foundClass = classParam;
      student = db.classes[classParam].students.find(s => normalizeId(s.id) === normalizeId(id));
    }
    if(!student) {
      // search all classes
      for(const k of Object.keys(db.classes)){
        const s = db.classes[k].students.find(x => normalizeId(x.id) === normalizeId(id));
        if(s){ student = s; foundClass = k; break; }
      }
    }
    if(!student) {
      if(confirm('Studente non trovato. Crearlo con questo ID?')){
        const name = prompt('Nome studente') || 'Nuovo Studente';
        // default to 1A
        const defaultClass = '1A';
        db.classes[defaultClass] = db.classes[defaultClass] || { cols: [], students: [] };
        const obj = { id: id.trim(), name: name.trim(), transactions: [] };
        db.classes[defaultClass].students.push(obj);
        saveDB(db);
        location.href = 'student.html?id=' + encodeURIComponent(obj.id) + '&c=' + encodeURIComponent(defaultClass);
      } else {
        location.href='index.html';
      }
    } else {
      // render
      document.getElementById('stuName').textContent = student.name;
      document.getElementById('stuSubtitle').textContent = 'ID: ' + student.id + (foundClass ? ' • Classe: '+foundClass : '');
      document.getElementById('stuBalance').textContent = '€' + sumArray(student.transactions).toFixed(2);
      const list = document.getElementById('transList');
      list.innerHTML = '';
      (student.transactions || []).forEach((t, i)=>{
        const div = document.createElement('div');
        div.className = 'log-entry';
        const left = document.createElement('div');
        left.textContent = (db.classes[foundClass] && db.classes[foundClass].cols[i]) ? db.classes[foundClass].cols[i].label : ('T'+(i+1));
        const right = document.createElement('div');
        right.textContent = (t>0?'+':'') + t;
        right.style.fontWeight = '600';
        div.appendChild(left); div.appendChild(right);
        list.appendChild(div);
      });

      document.getElementById('addTrans').addEventListener('click', ()=>{
        const a = parseFloat(document.getElementById('amount').value);
        const note = document.getElementById('note').value || '';
        if(isNaN(a)) return alert('Inserisci importo valido');
        const db2 = loadDB();
        // add new column label and append value at the end
        const cls = foundClass || '1A';
        db2.classes[cls].cols.push({id:'col'+Date.now(), label: note || (new Date()).toLocaleString()});
        const idx = db2.classes[cls].cols.length - 1;
        db2.classes[cls].students.forEach(s=>{
          s.transactions = s.transactions || [];
          if(normalizeId(s.id) === normalizeId(student.id)){
            s.transactions[idx] = a;
          } else {
            s.transactions[idx] = s.transactions[idx] || null;
          }
        });
        saveDB(db2);
        location.reload();
      });

      // back to class link
      document.getElementById('backClass').href = 'class.html?c=' + encodeURIComponent(foundClass || '1A');
    }
  }
</script>
</body>
</html>
