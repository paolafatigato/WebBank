<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolBank - Sistema Autonomo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav h1 {
            color: #667eea;
            font-size: 24px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Dashboard View */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #999;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .balance {
            font-weight: bold;
            font-size: 16px;
        }

        .balance.positive { color: #10b981; }
        .balance.zero { color: #6b7280; }
        .balance.negative { color: #ef4444; }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin: 0 2px;
        }

        .btn-add { background: #10b981; color: white; }
        .btn-remove { background: #ef4444; color: white; }
        .btn-history { background: #667eea; color: white; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-delete { background: #ef4444; color: white; }

        /* NFC View */
        .nfc-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .nfc-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .nfc-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .nfc-button:hover {
            transform: scale(1.05);
        }

        .student-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            border-left: 5px solid #667eea;
            text-align: left;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .student-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .student-balance-big {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .action-add {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .action-remove {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Settings View */
        .settings-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .transaction-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9ff;
            border-radius: 5px;
        }

        .transaction-date {
            font-size: 12px;
            color: #999;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 18px;
        }

        .transaction-note {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="nav">
            <h1>🏦 SchoolBank</h1>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="switchView('dashboard')">📊 Dashboard</button>
                <button class="nav-btn" onclick="switchView('nfc')">📱 NFC</button>
                <button class="nav-btn" onclick="switchView('settings')">⚙️ Gestione</button>
            </div>
        </div>

        <div id="status" class="status"></div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="view active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Totale Studenti</div>
                    <div class="stat-value" id="totalStudents">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Saldo Totale</div>
                    <div class="stat-value" id="totalBalance">€0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Media Saldo</div>
                    <div class="stat-value" id="avgBalance">€0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Transazioni Oggi</div>
                    <div class="stat-value" id="todayTransactions">0</div>
                </div>
            </div>

            <div class="controls">
                <div class="controls-grid">
                    <div class="input-group">
                        <label>💰 Importo</label>
                        <input type="number" id="massAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>📝 Motivazione</label>
                        <input type="text" id="massNote" placeholder="Es: Premio comportamento">
                    </div>
                    <div class="input-group">
                        <label>Azione</label>
                        <select id="massAction">
                            <option value="add">➕ Aggiungi</option>
                            <option value="remove">➖ Sottrai</option>
                            <option value="set">🎯 Imposta</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="applyMassAction()">Applica ai Selezionati</button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>Studente</th>
                            <th>ID NFC</th>
                            <th>Saldo</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- NFC VIEW -->
        <div id="nfcView" class="view">
            <div class="nfc-container">
                <div class="nfc-icon">📱</div>
                <h2>Scansiona Carta NFC</h2>
                <p style="color: #999; margin: 20px 0;">Avvicina la carta NFC al telefono</p>
                <button class="nfc-button" onclick="startNFCScan()">🔍 Avvia Scansione</button>
                
                <div style="margin-top: 30px; padding-top: 30px; border-top: 2px dashed #ddd;">
                    <p style="color: #999; margin-bottom: 10px;">🧪 Test manuale (senza NFC):</p>
                    <input type="text" id="testNfcId" placeholder="Inserisci ID (es: FF:0F:2A:6F)" 
                           style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; margin-bottom: 10px;">
                    <button class="btn-primary" onclick="testNFCSearch()">Cerca Studente</button>
                </div>

                <div id="nfcStudentCard" style="display: none;"></div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="view">
            <div class="settings-container">
                <div class="settings-section">
                    <h3>➕ Aggiungi Nuovo Studente</h3>
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="newStudentName" placeholder="Es: Rossi Mario">
                    </div>
                    <div class="form-group">
                        <label>ID NFC</label>
                        <input type="text" id="newStudentId" placeholder="Es: FF:0F:2A:6F:51:01:00">
                    </div>
                    <div class="form-group">
                        <label>Saldo Iniziale</label>
                        <input type="number" id="newStudentBalance" value="0" step="0.01">
                    </div>
                    <button class="btn-primary" onclick="addNewStudent()">➕ Aggiungi Studente</button>
                </div>

                <div class="settings-section">
                    <h3>💾 Gestione Dati</h3>
                    <div class="btn-group">
                        <button class="btn-primary btn-success" onclick="exportData()">📥 Esporta Dati (JSON)</button>
                        <button class="btn-primary btn-warning" onclick="document.getElementById('importFile').click()">📤 Importa Dati</button>
                        <button class="btn-primary btn-danger" onclick="clearAllData()">🗑️ Cancella Tutto</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>

                <div class="settings-section">
                    <h3>📊 Statistiche Sistema</h3>
                    <div id="systemStats" style="padding: 20px; background: #f8f9ff; border-radius: 8px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Storico -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHistory()">&times;</span>
            <h2 id="historyTitle">Storico Transazioni</h2>
            <div id="historyContent" class="transaction-log"></div>
        </div>
    </div>

    <!-- Modal Modifica -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEdit()">&times;</span>
            <h2>✏️ Modifica Studente</h2>
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>ID NFC</label>
                <input type="text" id="editId">
            </div>
            <div class="form-group">
                <label>Saldo</label>
                <input type="number" id="editBalance" step="0.01">
            </div>
            <button class="btn-primary" onclick="saveEdit()">💾 Salva Modifiche</button>
        </div>
    </div>

    <script>
        class SchoolBankSystem {
            constructor() {
                this.students = [];
                this.transactions = [];
                this.currentEditIndex = -1;
                this.loadData();
                this.render();
            }

            loadData() {
                const studentsData = localStorage.getItem('schoolbank_students');
                const transactionsData = localStorage.getItem('schoolbank_transactions');
                
                if (studentsData) {
                    this.students = JSON.parse(studentsData);
                } else {
                    // Dati di esempio iniziali
                    this.students = [
                        { id: 'FF:0F:2A:6F:51:01:00', name: 'ALLMETA REINA', balance: 10, selected: false },
                        { id: 'FF:0F:2B:A1:23:45:67', name: 'ATANASOVA BARBARA', balance: 0, selected: false },
                        { id: 'FF:0F:2C:B2:34:56:78', name: 'BANCE AIDA', balance: 5, selected: false }
                    ];
                    this.saveData();
                }
                
                if (transactionsData) {
                    this.transactions = JSON.parse(transactionsData);
                } else {
                    this.transactions = [];
                }
            }

            saveData() {
                localStorage.setItem('schoolbank_students', JSON.stringify(this.students));
                localStorage.setItem('schoolbank_transactions', JSON.stringify(this.transactions));
            }

            addStudent(name, id, balance = 0) {
                // Controlla se l'ID esiste già
                if (this.students.some(s => s.id === id)) {
                    this.showStatus('ID NFC già esistente!', 'error');
                    return false;
                }

                this.students.push({
                    id: id.trim(),
                    name: name.trim(),
                    balance: parseFloat(balance),
                    selected: false
                });
                
                this.saveData();
                this.render();
                closeEdit();
                this.showStatus('Studente modificato!', 'success');
            }

            searchByNFC(nfcId) {
                const student = this.students.find(s => s.id === nfcId || s.id.includes(nfcId));
                if (student) {
                    this.displayNFCStudent(student);
                } else {
                    this.showStatus('Studente non trovato: ' + nfcId, 'error');
                }
            }

            displayNFCStudent(student) {
                const card = document.getElementById('nfcStudentCard');
                card.innerHTML = `
                    <div class="student-card">
                        <div class="student-header">
                            <div>
                                <div class="student-name">${student.name}</div>
                                <div style="color: #999; font-size: 14px; margin-top: 5px;">${student.id}</div>
                            </div>
                            <div class="student-balance-big">€${student.balance.toFixed(2)}</div>
                        </div>
                        
                        <div class="input-group">
                            <label>Importo Personalizzato</label>
                            <input type="number" id="nfcCustomAmount" placeholder="0.00" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px;">
                        </div>
                        
                        <div class="quick-actions">
                            <button class="action-btn action-add" onclick="app.nfcTransaction('${student.id}', 5)">+ 5€</button>
                            <button class="action-btn action-remove" onclick="app.nfcTransaction('${student.id}', -5)">- 5€</button>
                            <button class="action-btn action-add" onclick="app.nfcCustomTransaction('${student.id}', 'add')">+ Custom</button>
                            <button class="action-btn action-remove" onclick="app.nfcCustomTransaction('${student.id}', 'remove')">- Custom</button>
                        </div>
                        
                        <button class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="app.showHistory(${this.students.findIndex(s => s.id === student.id)})">
                            📋 Vedi Storico Completo
                        </button>
                    </div>
                `;
                card.style.display = 'block';
                this.showStatus('Studente trovato!', 'success');
            }

            nfcTransaction(studentId, amount) {
                this.addTransaction(studentId, amount, 'Transazione NFC');
                const student = this.students.find(s => s.id === studentId);
                this.displayNFCStudent(student); // Aggiorna la visualizzazione
                this.showStatus(`${amount > 0 ? 'Aggiunti' : 'Sottratti'} €${Math.abs(amount).toFixed(2)}`, 'success');
            }

            nfcCustomTransaction(studentId, type) {
                const amount = parseFloat(document.getElementById('nfcCustomAmount').value);
                if (!amount || amount <= 0) {
                    this.showStatus('Inserisci un importo valido', 'error');
                    return;
                }
                
                const finalAmount = type === 'add' ? amount : -amount;
                this.nfcTransaction(studentId, finalAmount);
                document.getElementById('nfcCustomAmount').value = '';
            }

            exportData() {
                const data = {
                    students: this.students,
                    transactions: this.transactions,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `schoolbank_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                this.showStatus('Dati esportati!', 'success');
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.students && Array.isArray(data.students)) {
                            if (confirm('Vuoi sostituire i dati esistenti o aggiungerli?\\n\\nOK = Sostituisci\\nAnnulla = Aggiungi')) {
                                this.students = data.students;
                                this.transactions = data.transactions || [];
                            } else {
                                this.students = [...this.students, ...data.students];
                                this.transactions = [...this.transactions, ...(data.transactions || [])];
                            }
                            
                            this.saveData();
                            this.render();
                            this.showStatus('Dati importati con successo!', 'success');
                        } else {
                            this.showStatus('File non valido', 'error');
                        }
                    } catch (error) {
                        this.showStatus('Errore durante l\'importazione', 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset input
                event.target.value = '';
            }

            clearAllData() {
                if (confirm('⚠️ ATTENZIONE! Questo cancellerà TUTTI i dati.\n\nSei ASSOLUTAMENTE sicuro?')) {
                    if (confirm('Ultima conferma: cancellare tutto?')) {
                        localStorage.removeItem('schoolbank_students');
                        localStorage.removeItem('schoolbank_transactions');
                        this.students = [];
                        this.transactions = [];
                        this.render();
                        this.showStatus('Tutti i dati sono stati cancellati', 'info');
                    }
                }
            }

            updateSystemStats() {
                const stats = document.getElementById('systemStats');
                const totalTrans = this.transactions.length;
                const totalIn = this.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
                const totalOut = this.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
                stats.innerHTML = `
                    <p><strong>Totale Transazioni:</strong> ${totalTrans}</p>
                    <p><strong>Totale Entrate:</strong> €${totalIn.toFixed(2)}</p>
                    <p><strong>Totale Uscite:</strong> €${totalOut.toFixed(2)}</p>
                    <p><strong>Ultimo Backup:</strong> Mai (usa Esporta Dati)</p>
                `;
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Inizializza app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new SchoolBankSystem();
        });

        // Funzioni UI
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewName + 'View').classList.add('active');
            event.target.classList.add('active');
            
            if (viewName === 'settings') {
                app.updateSystemStats();
            }
        }

        function toggleSelectAll() {
            app.toggleSelectAll();
        }

        function applyMassAction() {
            app.applyMassAction();
        }

        function addNewStudent() {
            const name = document.getElementById('newStudentName').value;
            const id = document.getElementById('newStudentId').value;
            const balance = document.getElementById('newStudentBalance').value;
            
            if (!name || !id) {
                app.showStatus('Nome e ID sono obbligatori', 'error');
                return;
            }
            
            if (app.addStudent(name, id, balance)) {
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentId').value = '';
                document.getElementById('newStudentBalance').value = '0';
            }
        }

        function exportData() {
            app.exportData();
        }

        function importData(event) {
            app.importData(event);
        }

        function clearAllData() {
            app.clearAllData();
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function closeEdit() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveEdit() {
            app.saveEdit();
        }

        // NFC Functions
        async function startNFCScan() {
            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    
                    app.showStatus('Scansione attiva... Avvicina la carta', 'info');
                    
                    ndef.addEventListener('reading', ({ message, serialNumber }) => {
                        const nfcId = serialNumber.toUpperCase().replace(/:/g, ':');
                        document.getElementById('testNfcId').value = nfcId;
                        app.searchByNFC(nfcId);
                    });
                    
                } catch (error) {
                    app.showStatus('Errore NFC: ' + error, 'error');
                }
            } else {
                app.showStatus('NFC non supportato su questo browser. Usa Chrome su Android o il test manuale.', 'error');
            }
        }

        function testNFCSearch() {
            const nfcId = document.getElementById('testNfcId').value;
            if (nfcId) {
                app.searchByNFC(nfcId);
            } else {
                app.showStatus('Inserisci un ID NFC', 'error');
            }
        }

        // Check URL parameters (per link diretti da NFC tag)
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const nfcId = urlParams.get('nfc');
            
            if (nfcId) {
                switchView('nfc');
                document.getElementById('testNfcId').value = nfcId;
                setTimeout(() => app.searchByNFC(nfcId), 500);
            }
        });
    </script>
</body>
</html>showStatus('Studente aggiunto con successo!', 'success');
                return true;
            }

            deleteStudent(index) {
                if (confirm('Sei sicuro di voler eliminare questo studente?')) {
                    const student = this.students[index];
                    this.students.splice(index, 1);
                    
                    // Rimuovi anche le transazioni associate
                    this.transactions = this.transactions.filter(t => t.studentId !== student.id);
                    
                    this.saveData();
                    this.render();
                    this.showStatus('Studente eliminato', 'success');
                }
            }

            addTransaction(studentId, amount, note = '') {
                const transaction = {
                    id: Date.now(),
                    studentId: studentId,
                    amount: parseFloat(amount),
                    note: note,
                    date: new Date().toISOString()
                };
                
                this.transactions.push(transaction);
                
                // Aggiorna saldo studente
                const student = this.students.find(s => s.id === studentId);
                if (student) {
                    student.balance += parseFloat(amount);
                }
                
                this.saveData();
            }

            getStudentTransactions(studentId) {
                return this.transactions
                    .filter(t => t.studentId === studentId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            getTodayTransactions() {
                const today = new Date().toDateString();
                return this.transactions.filter(t => 
                    new Date(t.date).toDateString() === today
                ).length;
            }

            render() {
                this.renderDashboard();
                this.renderStats();
                this.updateSystemStats();
            }

            renderDashboard() {
                const tbody = document.getElementById('studentsTable');
                
                if (this.students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">Nessuno studente. Vai in Gestione per aggiungerne.</td></tr>';
                    return;
                }

                tbody.innerHTML = this.students.map((student, index) => `
                    <tr>
                        <td><input type="checkbox" ${student.selected ? 'checked' : ''} onchange="app.toggleStudent(${index})"></td>
                        <td><strong>${student.name}</strong></td>
                        <td style="font-family: monospace; font-size: 12px;">${student.id}</td>
                        <td><span class="balance ${student.balance > 0 ? 'positive' : student.balance < 0 ? 'negative' : 'zero'}">€${student.balance.toFixed(2)}</span></td>
                        <td>
                            <button class="btn-small btn-add" onclick="app.quickTransaction(${index}, 5)">+5€</button>
                            <button class="btn-small btn-remove" onclick="app.quickTransaction(${index}, -5)">-5€</button>
                            <button class="btn-small btn-history" onclick="app.showHistory(${index})">📋</button>
                            <button class="btn-small btn-edit" onclick="app.editStudent(${index})">✏️</button>
                            <button class="btn-small btn-delete" onclick="app.deleteStudent(${index})">🗑️</button>
                        </td>
                    </tr>
                `).join('');
            }

            renderStats() {
                const total = this.students.length;
                const totalBalance = this.students.reduce((sum, s) => sum + s.balance, 0);
                const avg = total > 0 ? totalBalance / total : 0;
                const todayTrans = this.getTodayTransactions();

                document.getElementById('totalStudents').textContent = total;
                document.getElementById('totalBalance').textContent = '€' + totalBalance.toFixed(2);
                document.getElementById('avgBalance').textContent = '€' + avg.toFixed(2);
                document.getElementById('todayTransactions').textContent = todayTrans;

                const selected = this.students.filter(s => s.selected).length;
                document.getElementById('selectAll').checked = total > 0 && selected === total;
            }

            toggleStudent(index) {
                this.students[index].selected = !this.students[index].selected;
                this.renderStats();
            }

            toggleSelectAll() {
                const checked = document.getElementById('selectAll').checked;
                this.students.forEach(s => s.selected = checked);
                this.render();
            }

            quickTransaction(index, amount) {
                const student = this.students[index];
                this.addTransaction(student.id, amount, 'Transazione rapida');
                this.render();
                this.showStatus(`${amount > 0 ? 'Aggiunti' : 'Sottratti'} €${Math.abs(amount).toFixed(2)} a ${student.name}`, 'success');
            }

            applyMassAction() {
                const amount = parseFloat(document.getElementById('massAmount').value);
                const note = document.getElementById('massNote').value || 'Operazione multipla';
                const action = document.getElementById('massAction').value;

                if (!amount || amount <= 0) {
                    this.showStatus('Inserisci un importo valido', 'error');
                    return;
                }

                const selected = this.students.filter(s => s.selected);
                if (selected.length === 0) {
                    this.showStatus('Seleziona almeno uno studente', 'error');
                    return;
                }

                let finalAmount = amount;
                if (action === 'remove') finalAmount = -amount;

                selected.forEach(student => {
                    if (action === 'set') {
                        const diff = amount - student.balance;
                        this.addTransaction(student.id, diff, note);
                    } else {
                        this.addTransaction(student.id, finalAmount, note);
                    }
                });

                this.render();
                this.showStatus(`Operazione completata su ${selected.length} studenti!`, 'success');
                
                document.getElementById('massAmount').value = '';
                document.getElementById('massNote').value = '';
            }

            showHistory(index) {
                const student = this.students[index];
                const transactions = this.getStudentTransactions(student.id);
                
                document.getElementById('historyTitle').textContent = `📋 ${student.name}`;
                
                const content = document.getElementById('historyContent');
                if (transactions.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nessuna transazione</p>';
                } else {
                    content.innerHTML = transactions.map(t => `
                        <div class="transaction-item">
                            <div class="transaction-date">${new Date(t.date).toLocaleString('it-IT')}</div>
                            <div class="transaction-amount ${t.amount > 0 ? 'positive' : 'negative'}">
                                ${t.amount > 0 ? '+' : ''}€${t.amount.toFixed(2)}
                            </div>
                            ${t.note ? `<div class="transaction-note">${t.note}</div>` : ''}
                        </div>
                    `).join('');
                }
                
                document.getElementById('historyModal').classList.add('active');
            }

            editStudent(index) {
                this.currentEditIndex = index;
                const student = this.students[index];
                
                document.getElementById('editName').value = student.name;
                document.getElementById('editId').value = student.id;
                document.getElementById('editBalance').value = student.balance;
                
                document.getElementById('editModal').classList.add('active');
            }

            saveEdit() {
                if (this.currentEditIndex === -1) return;
                
                const student = this.students[this.currentEditIndex];
                const newName = document.getElementById('editName').value.trim();
                const newId = document.getElementById('editId').value.trim();
                const newBalance = parseFloat(document.getElementById('editBalance').value);
                
                if (!newName || !newId) {
                    this.showStatus('Nome e ID sono obbligatori', 'error');
                    return;
                }
                
                student.name = newName;
                student.id = newId;
                student.balance = newBalance;
                
                this.saveData();
                this.render();
                this.
